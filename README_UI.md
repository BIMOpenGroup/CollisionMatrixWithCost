# Руководство по интерфейсу Матрицы цен

## Навигация
- `Матрица` — просмотр исходной матрицы коллизий без цен.
- `Матрица со стоимостью` — матрица с диапазоном цены коллизии и суммой принятых позиций.
- `Элементы` — ранжирование прайса для выбранной строки матрицы.
- `Дисциплины` — ранжирование прайса по дисциплинам (группам).
- `LLM` — проверка провайдера и пинг модели.
- `Журнал` — события приёмки/отказа предложений и действий.

## Матрица
- `Сохранить дисциплины` — сохранение групп строк/колонок из CSV в базу.
- `Авто‑одобрить стоимости (Элементы, LLM)` — LLM автоматически принимает/отклоняет цены по элементам, чтобы сформировать базу «принятых» позиций.
- Клик по названию элемента строки открывает список предложений цен для этого элемента.

## Матрица со стоимостью
- `Синхронизировать ячейки` — создание/обновление ключей всех ячеек по CSV.
- `Обновить сводку` — перезагрузка `min–max`, суммы и статусов ячеек.
- `Запустить расчёт коллизий (LLM)` — LLM генерирует сценарии устранения коллизий; сервер автоматически сопоставляет работы со справочником цен и считает диапазон `min–max` по суммам сценариев.
- `Запустить ранжирование важности (LLM)` — LLM оценивает опасность/важность/сложность для ячеек.
- Клик по ячейке открывает панель расчёта:
  - `Оценка коллизий` — показывает диапазон стоимости и список сценариев с обоснованием.
  - `Редактировать сценарии` — открывает JSON‑редактор сценариев.
  - `Сохранить` — записывает сценарии, автоматически сопоставляет работы со справочником и пересчитывает `min–max`.
  - Таблица «Работы» — для каждого сценария отображает: исходное название работы, соответствие прайсу, единицу, цену за единицу, количество, итог.
  - Таблица «Позиции, учтённые в расчёте» — принятые по строке/колонке позиции, попавшие в расчёт.
- Блок «Предложения (ячейка)»:
  - `Сгенерировать предложения (ячейка)` — сформировать релевантные цены для конкретной ячейки.
  - `Авто‑одобрить (LLM)` — LLM примет/отклонит предложения ячейки; принятые автоматически добавятся в расчёт.
  - Кнопка `Принять` — вручную принять предложение.
  - Кнопка `Отклонить` — вручную отклонить предложение.
  - `Добавить в ячейку` — добавить выбранную цену в принятые позиции ячейки.
  - Фильтр `Все виды работ` — отфильтровать предложения по виду работ.

## Элементы
- `Сгенерировать предложения (элементы)` — создать предложения цен для всех элементов матрицы.
- Выбор элемента происходит кликом по названию элемента строки на вкладке «Матрица».
- В таблице можно вручную принять/отклонить предложения.

## Дисциплины
- `Сгенерировать предложения (дисциплины)` — создать предложения цен по выбранной дисциплине.
- Выбор дисциплины из выпадающего списка.

## LLM
- Таблица провайдеров: Base URL, модель, наличие ключа.
- `Пинг` — быстрая проверка доступности LLM и корректности ключей.

## Журнал
- `Обновить` — перезагрузить список событий.
- Таблица показывает ID, тип, действие (accepted/rejected), цену, источник и контекст.

## Формат JSON сценариев
Сценарий — массив объектов:
```
[
  {
    "scenario": "Алмазная резка отверстия в монолитном ЖБ",
    "rationale": "Если трасса проходит через ЖБ‑КР, требуется алмазная резка",
    "items": [
      { "name": "Алмазная резка бетона", "quantity": 1 },
      { "name": "Вынос и уборка мусора", "quantity": 1 }
    ]
  }
]
```
- `name` — короткое название работы, как в прайсе.
- `quantity` — базовое количество для расчёта (по умолчанию 1, можно менять).
- Единицы `unit` и цена за единицу `unit_price` определяются автоматически при сопоставлении с прайсом; итог `total = unit_price × quantity`.

## Подсказки по редактированию
- Чем точнее совпадает `name` с реальным прайс‑наименованием, тем надёжнее сопоставление.
- Для обходов трассы добавляйте работы типа: «Монтаж трубы (п.м.)», «Штрабление», «Восстановление отделки/изоляции» и задавайте примерные `quantity`.
- После изменения JSON нажмите `Сохранить` — пересчёт выполняется сразу, диапазон обновится.

