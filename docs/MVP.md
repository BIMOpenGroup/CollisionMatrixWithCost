# CMWC — MVP план реализации

## Цель MVP
- Создать веб-приложение, которое реализует CMWC как интерактивную матрицу.
- Взять для примера базовую «матрицу коллизий с допусками» и преобразовать её в CMWC-версию: ячейки переходят от статусов «проверять/допустимо» к метрикам «стоимость риска/устранения».
- Обеспечить UI для настройки осей дисциплин, допусков, категорий (Major/Medium/Minor) и мэппинга на ГЭСНр, с расчётом стоимости и отчётами.
- Использовать данные по стоимости из открытых источников и ЛЛМ для формирования данных при заполнении таблиц (с проверкой и подтверждением пользователем).

## Объем MVP (Scope)
- Источники данных: BCF/HTML/XML экспорт из Navisworks/Solibri; ручной Excel для пилота допустим.
- Базовая матрица допусков: импорт/ручной ввод, редактор матрицы (оси дисциплин и допусков) прямо в UI.
- Категоризация: по вовлеченным сторонам и требуемым действиям (stakeholder involvement & required actions).
- Стоимость: подбор «пакетов работ» из ГЭСНр для устранения типовых коллизий; расчёт труд/материалы/оборудование/утилизация на уровне ячеек (пар дисциплин) и конкретных коллизий.
- Экстраполяция: средние стоимости по категориям × количество коллизий категории.
- Отчеты: Excel/CSV, PDF «Executive» с графиками, таблица «топ дорогих коллизий», визуализация стоимости на матрице.
- Открытые источники стоимости: отраслевые публикации, публичные сметные базы, прайс‑листы — для первичной калибровки.
- LLM‑ассистент: генерация предложений стоимости и мэппинга при заполнении таблицы; обязательная верификация пользователем и журнал источников.

## Артефакты и результаты
- Веб‑UI: редактор базовой матрицы допусков (оси дисциплин, допуски, цвета), конвертация в CMWC с показом стоимости по ячейкам.
- Библиотека Решений (mapping): коллизия/ячейка → пакет(ы) работ ГЭСНр + формулы количеств.
- Движок стоимости: расчёт стоимости устранения для ячеек (по правилам) и конкретных коллизий.
- Категоризатор: правила отнесения к Major/Medium/Minor для ячеек и/или конкретных случаев.
- Импорт/Экспорт: парсеры BCF/XML/CSV, генераторы Excel/PDF, экспорт в «Гранд-Смета» (CSV/XLSX).
- Отчёты и визуализация: свод по проекту, «топ дорогих коллизий», тепловая карта стоимости по матрице.

## Входные данные
- BCF zip, Navisworks XML отчеты, CSV/Excel выгрузки.
- Изображения для методологии (для документации):
  - `research/images/Table 6 Clashes Categorisation.png`
  - `research/images/Table 7 Listing and categorisation summary of all clash instances.png`
  - `research/images/Table 9 Estimation of cost implication of a major clash.png`
  - `research/images/Table 11 Estimation of cost implication of a medium clash.png`
  - `research/images/Table 13 Estimation of cost implication of a minor clash.png`
  - `research/images/Table 14 Extrapolated overall achieved savings.png`

## Ключевая методология (основания)
- Категоризация по вовлеченным сторонам и действиям: Major (Подрядчик+Проектировщик+Заказчик), Medium (Подрядчик+Проектировщик), Minor (Подрядчик).
- Оценка: выбор репрезентативных образцов в каждой категории (минимум/максимум), расчет по реальным нормам ГЭСНр.
- Экстраполяция: средняя стоимость образцов × объем коллизий категории.
- Ценность BIM: перенос затрат на инжиниринг/демонтаж/штрафы «с площадки» в «проектирование».

## Архитектура MVP (рекомендуемая)
- Веб‑приложение: UI + API.
- Компоненты:
  - Матрица: UI‑редактор базовой матрицы допусков и CMWC‑матрицы (grid/heatmap).
  - Импорт: BCF/XML/CSV парсеры и сопоставление коллизий с ячейками (по дисциплинам).
  - Классификация: правила на основе метаданных и шаблонов (stakeholders & actions).
  - Стоимость: движок сопоставления с Библиотекой Решений и расчёт формул.
  - Агрегация/Экстраполяция: вычисление итогов и метрик (по ячейкам, категориям, всему проекту).
  - LLM‑ассистент: генерация предложений (стоимость, мэппинг) на основе открытых источников; верификация человеком; журнал и атрибуция источников.
  - Экспорт: Excel/CSV/PDF отчёты, выгрузка для сметных комплексов.
- Хранилище: `SQLite` для MVP (простая установка, переносимость).

## Модель данных (упрощенно)
- `Project`: id, name, description, settings (коэффициенты, индексация).
- `MatrixDefinition`: id, project_id, disciplines[], tolerance_rules.
- `MatrixCell`: id, matrix_id, disciplineA, disciplineB, tolerance_status, category (Major/Medium/Minor), cost_rules_ref.
- `Clash`: id, source, disciplineA/B, location, severity, category (Major/Medium/Minor), actions_required, stakeholders, geometry_metrics.
- `CostPackage` (ГЭСНр): id, code, title, unit, base_rate, components {labor, materials, equipment, waste}, notes.
- `Rule` (mapping): conditions → [CostPackage], quantity_formulas, adjustments.
- `Estimate`: clash_id, packages_applied, quantities, subtotal_labor/material/equipment/waste, total_cost, confidence.
- `ClashMapping`: clash_id, matrix_cell_id.
- `SampleSet`: category, sample_clashes[], mean_cost, low/high.
- `ProjectSummary`: totals_by_category, avoided_cost, ROI.

## Рабочий поток (workflow)
1. Создание проекта и базовой матрицы допусков: выбор дисциплин, настройка допусков и цветов.
2. Конвертация в CMWC: назначение категорий и правил стоимости для ячеек (mapping на ГЭСНр).
3. Импорт коллизий: загрузка BCF/XML/CSV и сопоставление с ячейками матрицы.
4. Расчёт: стоимость на уровне ячеек и коллизий, экстраполяция по категориям.
5. Отчёты и визуализация: тепловая карта стоимости, «ТОП дорогих коллизий», своды.
6. Выгрузка: CSV/XLSX в «Гранд-Смета» (без изменения внешних ссылок).

## Библиотека Решений (первичные шаблоны)
- Minor: «Труба в отделке стены» → пробивка отверстия, локальное восстановление отделки (ГЭСНр коды для сверления/демонтажа/отделки).
- Medium: «Воздуховод пересекает балку» → частичный демонтаж воздуховода, устройство обхода, восстановление огнестойкости.
- Major: «Дверь пересекается с колонной» → перенос/устройство нового проема, демонтаж перегородки, кладка, отделка, вывоз мусора.
- Для каждого шаблона: формулы количеств (площадь, длина, диаметр), коэффициенты (сложность, высота работ), базовые ставки.

## Отчеты (структура)
- Executive: общая экономия (avoided costs), распределение по категориям, графики.
- Инженерный: список коллизий с расчетами, примененные нормы ГЭСНр, confidence.
- Менеджерский: ТОП N коллизий по стоимости, рекомендации по порядку устранения.

## Метрики успеха
- Покрытие: ≥80% коллизий получили стоимость через мэппинг.
- Точность: средняя ошибка в пилотной валидации ≤15%.
- Время: расчеты для 500+ коллизий ≤10 минут.
- ROI: демонстрация избегаемых затрат по проекту.

## Таймлайн реализации (ориентир 6–8 недель)
- Неделя 1: каркас БД, базовый UI, редактор матрицы допусков.
- Неделя 2: конвертация матрицы в CMWC (категории, правила стоимости), прототип Библиотеки Решений.
- Неделя 3: импорт BCF/XML/CSV и сопоставление с ячейками матрицы.
- Неделя 4: калькулятор стоимости, отчёты и визуализация (heatmap, топы).
- Неделя 5: пилотная валидация образцов и экстраполяции.
- Неделя 6: доработка правил, метрики, финальная презентация.
- Неделя 7–8: опционально — Navisworks Add‑In (импорт clash‑тестов), улучшение UI.

## UX‑экраны MVP
- Редактор матрицы: оси дисциплин, допуски, цвета (baseline) → переключение на CMWC‑вид с показом стоимости.
- Мэппинг стоимости: назначение правил/ГЭСНр для ячеек, формулы количеств.
- Импорт коллизий: загрузка, просмотр, сопоставление с ячейками.
- Обзор стоимости: тепловая карта, ТОП коллизий, своды по категориям.
- Экспорт отчётов: Excel/PDF, выгрузка в «Гранд‑Смета».
- LLM‑ассистент: панель предложений для заполнения таблиц/ячееек (стоимость, мэппинг) с указанием источников и подтверждением пользователем.

## Риски и допущения
- Доступность и полнота норм ГЭСНр (ремонтные сборники) для всех шаблонов.
- Территориальные коэффициенты и индексация — на уровне настроек проекта.
- Контекст-специфичность: стоимость зависит от площадки/логистики — учитываем коэффициентами.
- Качество исходного BCF/XML: возможны неполные метаданные.

## Варианты стеков реализации

### Вариант A (рекомендуемый для MVP): Python + FastAPI + SQLite + простой веб-UI
- Backend: `Python 3.11`, `FastAPI` (API и расчет), `pydantic` (модели).
- Data: `SQLite` (легко развернуть), `SQLAlchemy`.
- Import: парсеры `BCF/XML/CSV` (стандартные библиотеки + `lxml`).
- UI: `React` или `Vue` (таблицы, фильтры, отчеты), сборка `Vite`.
- Отчеты: `pandas` + `openpyxl` (Excel), `WeasyPrint`/`ReportLab` (PDF).
- Плюсы: скорость прототипирования, кроссплатформенность, гибкость правил.
- Минусы: нет прямой интеграции с Navisworks из коробки, BCF/XML-поток обязателен.

### Вариант B: C# .NET + Navisworks Add-In + WPF + SQLite
- Backend/UI: `C# .NET 8` плагин для Navisworks, UI на `WPF`.
- Data: `SQLite`.
- Преимущества: нативный доступ к clash-тестам Navisworks, Windows-first.
- Ограничения: дольше разработка, дистрибуция плагина, зависимость от лицензий.

### Вариант C: TypeScript/Node + Next.js + Postgres + Autodesk Forge
- Backend: `Node.js`/`NestJS`, `Postgres`.
- Интеграция: Autodesk Forge Model Coordination API (облако), ACC/BIM 360.
- Плюсы: облако, мульти-пользователи, масштаб.
- Минусы: подписка Forge, сложность интеграции норм ГЭСНр, зависимость от внешних сервисов.

## Рекомендация по стеку
- Для MVP: выбрать Вариант A (Python + FastAPI + SQLite) — быстрее всего для доказательства ценности и подготовки методологии/Библиотеки Решений. В дорожной карте предусмотреть плагин Navisworks (Вариант B) как следующий шаг.

## Дорожная карта продуктов (после MVP)
- v1.0: стабильный сервис, расширенная Библиотека Решений, удобные отчеты.
- v1.1: плагин Navisworks, прямой импорт clash-тестов.
- v1.2: интеграция с «Гранд-Смета» (CSV/XLSX, при наличии — API), роль- и проект-ориентированная конфигурация коэффициентов.
- v1.3: облачный режим (Вариант C), многопользовательские рабочие места.

---

## Приложения
- Категоризация и примеры оценок — см. изображения в `research/images/`.
- Внешние ссылки в источниках не изменяются.