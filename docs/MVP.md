# CMWC — MVP план реализации

## Цель MVP
- Создать веб-приложение, которое реализует CMWC как интерактивную матрицу.
- Взять для примера базовую «матрицу коллизий с допусками» и преобразовать её в CMWC-версию: ячейки переходят от статусов «проверять/допустимо» к метрикам «стоимость риска/устранения».
- Обеспечить UI для отображения стоимости коллизий; стоимости разделены на три группы (Major/Medium/Minor); мэппинг на ГЭСНр; расчёт стоимости и отчёты.
- Использовать данные по стоимости из открытых источников и ЛЛМ для формирования данных при заполнении таблиц (с проверкой и подтверждением пользователем).

## Объем MVP (Scope)
- Источники данных: внешние ресурсы расценок ГЭСНр, публичные сметные базы, прайс‑листы.
- Базовая матрица допусков: сформирована как пример при старте проекта.
- Категоризация: по вовлеченным сторонам и требуемым действиям (stakeholder involvement & required actions).
- Стоимость: подбор «пакетов работ» из ГЭСНр для устранения типовых коллизий; расчёт труд/материалы/оборудование/утилизация на уровне ячеек (пар дисциплин) и конкретных коллизий.
- Отчеты: визуализация стоимости на матрице.
- Открытые источники стоимости: отраслевые публикации, публичные сметные базы, прайс‑листы — для первичной калибровки.
- LLM‑ассистент: генерация предложений стоимости и мэппинга при заполнении таблицы; обязательная верификация пользователем и журнал источников.
- Сохранение данных в локальной базе SQLite: матрица допусков, стоимости, категории, мэппинги, пакеты работ и ссылки на ГЭСНр и источники стоимости.

## Артефакты и результаты
- Веб‑UI: на основе базовой матрицы допусков (оси дисциплин, допуски, цвета), конвертация в CMWC с показом стоимости по ячейкам (оси дисциплин, стоймость, цвета).
- Библиотека Решений (mapping): коллизия/ячейка → пакет(ы) работ ГЭСНр + формулы количеств.
- Движок стоимости: расчёт стоимости устранения для ячеек (по правилам) и конкретных коллизий.
- Категоризатор: правила отнесения к Major/Medium/Minor по стоимости устранения коллизий.
- Отчёты и визуализация: свод по проекту, «топ дорогих коллизий», тепловая карта стоимости по матрице.

## Входные данные
- Базовая матрица допусков
- Изображения для методологии подсчетов:
  - `research/images/Table 6 Clashes Categorisation.png`
  - `research/images/Table 7 Listing and categorisation summary of all clash instances.png`
  - `research/images/Table 9 Estimation of cost implication of a major clash.png`
  - `research/images/Table 11 Estimation of cost implication of a medium clash.png`
  - `research/images/Table 13 Estimation of cost implication of a minor clash.png`
  - `research/images/Table 14 Extrapolated overall achieved savings.png`

## Ключевая методология (основания)
- Категоризация по вовлеченным сторонам и действиям: Major (Подрядчик+Проектировщик+Заказчик), Medium (Подрядчик+Проектировщик), Minor (Подрядчик).
- Оценка: выбор репрезентативных образцов в каждой категории (минимум/максимум), расчет по реальным нормам ГЭСНр.
- Экстраполяция: средняя стоимость образцов × объем коллизий категории.
- Ценность BIM: перенос затрат на инжиниринг/демонтаж/штрафы «с площадки» в «проектирование».

## Архитектура MVP
- Веб‑приложение: UI + API.
- Компоненты:
  - Матрица: UI‑интерфейс CMWC‑матрицы (grid/heatmap).
  - Классификация: правила на основе метаданных и шаблонов (stakeholders & actions).
  - Стоимость базовая: расценки с https://garantstroikompleks.ru/prajs-list
  - Стоимость продвинутая: движок сопоставления с ГЭСНр и расчёт формул.
  - LLM‑ассистент: интерпретирует категории элементов матрицы, подбирает соответствующие расценки ГЭСНр, генерирует предложения (стоимость, мэппинг) на основе открытых источников; верификация пользователем; журнал и атрибуция источников.
  - Экспорт: CSV отчёты.
- Хранилище: `SQLite` для MVP (простая установка, переносимость).

## Стек реализации: Node.js + SQLite + простой веб-UI
- Backend: `Node.js` (typeScript).
- Data: `SQLite` (легко развернуть).
- UI: `React`, сборка `Vite`.
- Плюсы: скорость прототипирования, кроссплатформенность, гибкость правил.

## Этапы реализации

Этап 00 — Инициализация
- Создать проект и инициализировать файл БД (`SQLite`)

Этап 0 — UI базовой матрицы допусков
- Интерпритация матрицы примера, дисциплин, допусков и цветов.
- Отобразить матрицу в виде `grid` с заполненными дисциплинами.
- Сохранить список дисциплин

Этап 1 — Парсинг базовых стоймостей с https://garantstroikompleks.ru/prajs-list
- Анализ сайта.
- Алгоритм парсинга HTML-страницы с таблицей стоимостей.
- Сохранение стоимостей данных в БД.
- Алгоритм интерпритации с использованием LLM запросов, для сопоставления дисциплин матрицы с данными garantstroikompleks

Этап 2 — Конвертация матрицы в CMWC
- Реализовать мэппинг ячеек с данными собранными из garantstroikompleks.
- Включить LLM‑ассистента: генерация предложений стоимости/мэппинга с показом источников и подтверждением пользователем.
- Вести журнал принятых/отклонённых предложений и атрибуцию источников.
- Добавить категории (Major/Medium/Minor) на уровне ячеек; правила назначения.

Этап 3 — Визуализация и отчёты
- Тепловая карта стоимости на матрице; фильтры по категориям/дисциплинам.
- Экспорт в `CSV`.

## Пошаговая реализация (чек‑лист)

### Этап 00 — Инициализация
- [x] Создать проект
- [x] Инициализировать файл БД (`SQLite`)

### Этап 0 — UI базовой матрицы допусков
- [x] Интерпритация матрицы примера, дисциплин, допусков и цветов.
- [x] Отобразить матрицу в виде `grid` с заполненными дисциплинами.
- [x] Сохранить список дисциплин

### Этап 1 — Парсинг базовых стоймостей с https://garantstroikompleks.ru/prajs-list
- [x] Анализ сайта.
- [x] Алгоритм парсинга HTML-страницы с таблицей стоимостей.
- [x] Сохранение стоимостей данных в БД.

### Этап 1.1 — Интерпритации с использованием LLM запросов
- [x] Алгоритм интерпритации с использованием LLM запросов, для сопоставления дисциплин матрицы с данными garantstroikompleks

### Этап 1.2
- [x] Реализация через АПИ Мистраль https://docs.mistral.ai/api

Интеграция выполнена в `backend/src/llm.ts`:
- Выбор провайдера по переменным окружения: при наличии `MISTRAL_API_KEY` используется Mistral, иначе — `OPENAI_API_KEY` (fallback).
- Конечная точка: `POST https://api.mistral.ai/v1/chat/completions` с сообщениями `system` и `user`.
- Формат ответа: ожидается JSON‑объект с массивом ранжирования `[{index, score}]`.

Как запустить с Mistral:
- Установите переменную окружения `MISTRAL_API_KEY`.
- Необязательно: `MISTRAL_MODEL` (по умолчанию `mistral-small-latest`).
- Запустите бэкенд: `npm run dev` в каталоге `backend`. Сервер будет использовать Mistral для переранжирования кандидатов в `/api/mapping/suggest` и `/api/mapping/elements/suggest`.

Пример запроса (для справки):
```
POST https://api.mistral.ai/v1/chat/completions
Authorization: Bearer $MISTRAL_API_KEY
Content-Type: application/json

{
  "model": "mistral-small-latest",
  "messages": [
    { "role": "system", "content": "Ты помощник-сметчик..." },
    { "role": "user", "content": "Дисциплина: АУПТ..." }
  ],
  "temperature": 0.2,
  "response_format": { "type": "json_object" }
}
```

### Этап 2 — Конвертация матрицы в CMWC
- [ ] Реализовать мэппинг ячеек с данными собранными из garantstroikompleks.
- [ ] Включить LLM‑ассистента: генерация предложений стоимости/мэппинга с показом источников и подтверждением пользователем.
- [ ] Вести журнал принятых/отклонённых предложений и атрибуцию источников.
- [ ] Добавить категории (Major/Medium/Minor) на уровне ячеек; правила назначения.

### Этап 3 — Визуализация и отчёты
- [ ] Тепловая карта стоимости на матрице; фильтры по категориям/дисциплинам.
- [ ] Экспорт в `CSV`.


