# Отчет по анализу кодовой базы CMWC (Pre-Refactoring Analysis)

## 1. Статус реализации MVP

Анализ текущего кода (`backend/src`, `frontend/src`) по сравнению с планом `docs/MVP.md` показал следующее:

| Функционал MVP | Статус | Комментарий |
| :--- | :--- | :--- |
| **Инициализация БД (SQLite)** | ✅ Готово | Реализовано в `db.ts`. |
| **UI Базовой матрицы** | ✅ Готово | Загрузка из CSV, отображение (`MatrixTab.tsx`). |
| **Парсинг цен (Garant)** | ✅ Готово | `scrapeGarant.ts` + API `/api/prices/scrape`. |
| **Мэппинг Дисциплин** | ✅ Готово | Эвристики + LLM rerank (`mapping.ts`). |
| **Мэппинг Элементов** | ✅ Готово | Эвристики + LLM rerank (`elementMapping.ts`). |
| **Мэппинг Ячеек (Cell Mapping)** | ⚠️ Частично | Реализовано в `cellMapping.ts`, но логика категорий (Major/Medium/Minor) на бэкенде явно не прослеживается. |
| **Расчет стоимости коллизий** | ⚠️ Частично | Есть `collision_costs` и `llmCollisionEstimate`, но нет явного движка "калькулятора" формул. |
| **Категоризация (Major/Medium/Minor)** | ❌ Отсутствует | В БД есть поля `hazard/importance` (риски), но нет автоматической классификации по стоимости. |
| **Экспорт в CSV** | ❌ Отсутствует | API endpoint для экспорта не найден. |
| **LLM Ассистент** | ✅ Готово | Интеграция Mistral/OpenAI, логгирование, верификация пользователем. |

## 2. Проблемные места и Технический долг

### 2.1 Дублирование кода (Code Duplication)
Выявлено значительное дублирование логики, которое усложнит поддержку:

1.  **Нормализация строк**: Функция `normalize` (или `norm`) дублируется в:
    -   `backend/src/mapping.ts`
    -   `backend/src/elementMapping.ts`
    -   `backend/src/cellMapping.ts`
    -   `backend/src/scrapeGarant.ts`
2.  **LLM Запросы**: В `backend/src/llm.ts` функции `llmDecideCell`, `llmDecideElement`, `llmRiskEstimate`, `llmCollisionEstimate` имеют практически идентичную структуру (подготовка промпта -> вызов API -> парсинг JSON -> логирование).
3.  **Эвристический скоринг**: Логика сопоставления токенов (`score...`) похожа в `mapping.ts`, `elementMapping.ts`, `cellMapping.ts`.

### 2.2 Архитектурные недостатки
1.  **Загрузка Матрицы**: Файл `matrix.csv` читается и парсится **синхронно** при каждом запросе к API (`loadMatrixFromCsv` вызывается внутри хендлеров). Это приведет к проблемам с производительностью при нагрузке.
    -   *Рекомендация:* Кэшировать матрицу в памяти при старте сервера.
2.  **Монолитный `db.ts`**: Файл `backend/src/db.ts` (900+ строк) содержит всё: инициализацию, схемы таблиц, CRUD операции.
    -   *Рекомендация:* Разбить на DAO (Data Access Objects) или репозитории по сущностям (`PricesRepository`, `MappingRepository` и т.д.).
3.  **Хрупкий Парсер**: `scrapeGarant.ts` жестко завязан на HTML структуру (заголовки `h1-h5` перед таблицами). Любое изменение верстки сайта-донора сломает парсер.
4.  **Отсутствие Валидации**: В API (`app.ts`) валидация входных данных минимальна (проверка типов через `typeof`). Рекомендуется использовать схему-валидатор (например, `zod`).

### 2.3 Неиспользуемые или сомнительные модули
-   В `backend/src/tasks.ts` (который импортируется в `app.ts`) реализована система фоновых задач, но её активное использование в бизнес-логике не очевидно из беглого просмотра (используется для `auto_approve_elements`, но насколько это актуально?).
-   `backend/src/scripts` содержит скрипты `cleanupOrphans.ts` и `runMapping.ts`, которые, вероятно, нужны только для dev-режима, но находятся в src.

## 3. Рекомендации по рефакторингу

1.  **Выделение Shared Utils**: Создать `backend/src/utils/string.ts` для нормализации и токенизации.
2.  **Унификация LLM Client**: Рефакторить `llm.ts`, создав универсальную функцию `llmRequest<T>`, принимающую промпт и схему валидации ответа.
3.  **Оптимизация работы с Матрицей**: Загружать CSV один раз при старте (`index.ts`) и передавать объект матрицы в сервисы.
4.  **Структурирование БД**: Разнести `db.ts` на отдельные модули.
5.  **Реализация недостающего функционала**:
    -   Добавить API для экспорта отчетов.
    -   Реализовать логику категоризации (Major/Medium/Minor) на основе рассчитанных стоимостей.

## 4. Вывод
Проект находится в функциональном состоянии "Proof of Concept". Основные риски связаны с дублированием кода и отсутствием архитектурного слоения (Layers). Для перехода к полноценному MVP необходимо устранить дублирование и реализовать недостающую бизнес-логику (категоризация, экспорт).
