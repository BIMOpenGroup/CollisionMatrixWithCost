## Цели
- Удалить неиспользуемые вкладки «Элементы» и «Дисциплины», связанные функции и таблицы.
- Упростить бэкенд: убрать эндпоинты ранжирования/мэппинга.
- Перенести отображение логов задач в вкладку «Журнал» и сделать её основным центром наблюдения.
- Сохранить актуальные функции: расчёт коллизий и рисков, CSV-матрицу, задачи и их логи.

## Журнал и Логи
- Существующая таблица `tasks` (`backend/src/db.ts:204-216`).
- Фронтенд:
  - Переделать `frontend/src/tabs/EventsTab.tsx`: показывать список задач (`GET /api/tasks`, `backend/src/app.ts:317-325`) с колонками: `id`, `type`, `status`, `progress`, `started_at/finished_at`, `message`.
  - Кнопку «Показать логи» в `frontend/src/components/TasksBar.tsx:10` заменить на переключение на вкладку «Журнал» и авто‑загрузку логов последней задачи.
-- Бэкенд:
  - Удалить маршруты/функции логов задач, впредь журнал показывает только `tasks`.

## Миграция БД
- Одноразово выполнить `DROP TABLE IF EXISTS` для удаляемых таблиц.
- Обновить `initDB()` так, чтобы эти таблицы больше не создавались.
- Проверить зависимые представления/запросы и убрать `JOIN` к удалённым таблицам.

## Валидация
- Сборка и запуск фронтенда/бэкенда, ручная проверка UI.
- Запуск тестов в тихом режиме: `npm run test:ci --silent` для обоих пакетов.
- Проверка, что вкладка «Журнал» показывает:
  - Старт/остановку/завершение задач.
  - Логи этапов задач.
  - Кнопка «Показать логи» ведёт к «Журналу» и сразу загружает логи последней задачи.

## Результат
- Интерфейс без легаси‑вкладок, без пустых таблиц и неиспользуемых эндпоинтов.
- Журнал — единая точка наблюдения за задачами и логами.

Подтвердите план — выполню правки, миграцию и проверку.
## Этапы и чекпоинты (обновлённый план)
### Цели
- Удалить неиспользуемые вкладки «Элементы» и «Дисциплины», связанные функции и таблицы.
- Упростить бэкенд: убрать эндпоинты ранжирования/мэппинга дисциплин и работу с предложениями/позициями ячеек.
- Перенести наблюдение за процессами в «Журнал» на базе `tasks`; убрать `task_logs`.
- Сохранить актуальные функции: расчёт коллизий и рисков, CSV-матрицу, задачи (`tasks`), `element_suggestions`.
- Сохранить `suggestion_events` как архив; удалить неиспользуемые столбцы.

### Этап 1. Очистка фронтенда: вкладки «Элементы»/«Дисциплины»
- Удалить кнопки/импорты: `frontend/src/AppOrchestrator.tsx:7-9,99-105`.
- Удалить состояние/запросы дисциплин: `frontend/src/AppOrchestrator.tsx:16,53-60`.
- Удалить загрузку статусов элементов: `frontend/src/AppOrchestrator.tsx:43-51`.
- Удалить панель предложений по элементу и подсветку: `frontend/src/tabs/MatrixTab.tsx:126,152-194`.
- Удалить вкладки: `frontend/src/tabs/ElementsTab.tsx:1-11`, `frontend/src/tabs/DisciplinesTab.tsx:1-89`.
- Чекпоинт: UI без «Элементы»/«Дисциплины», матрица без подсветки/панели ранжирования.

### Этап 2. Упрощение «Матрица со стоимостью»
- Удалить UI предложений и «Принятые позиции»: `frontend/src/tabs/CostMatrixTab.tsx:347-425`.
- Удалить фильтр `work_type`: `frontend/src/tabs/CostMatrixTab.tsx:350-355`.
- Удалить загрузку/подсветку статусов ячеек: `frontend/src/tabs/CostMatrixTab.tsx:71-77,143-145`.
- Чекпоинт: вкладка показывает только min–max и сценарии.

### Этап 3. «Журнал» на `tasks`
- Загрузка задач: `GET /api/tasks` `backend/src/app.ts:317-325`.
- Рендерить: `id`, `type`, `status`, `progress`, `started_at`, `finished_at`, `message` (`frontend/src/tabs/EventsTab.tsx:17-59`).
- Удалить «Показать логи»: `frontend/src/components/TasksBar.tsx:10,15-37`, состояние `activeLogs` (`frontend/src/AppOrchestrator.tsx:19`).
- Удалить `/api/tasks/:id/logs` (`backend/src/app.ts:305-315`) и `getTaskLogs` (`backend/src/db.ts:885-892`).
- Удалить вызовы `insertTaskLog` (`backend/src/tasks.ts:1,14,27,29,32,52,55,105,180,206`).
- Чекпоинт: «Журнал» показывает только `tasks`.

### Этап 4. Удаление неиспользуемых эндпоинтов
- Дисциплины: удалить `backend/src/app.ts:77-105`.
- Мэппинг дисциплин: удалить `backend/src/app.ts:106-128,130-145`.
- Предложения/позиции ячеек: удалить `backend/src/app.ts:354-393,395-421`.
- Статусы ячеек: удалить `backend/src/app.ts:599-606`.
- Эндпоинт журнала предложений: удалить `backend/src/app.ts:188-196`.
- Чекпоинт: остались матрица/CSV/LLM debug/`cells/init`/расчёты/`tasks`.

### Этап 5. Миграции БД: удалить пустые таблицы, упростить сводку
- Удалить таблицы: `disciplines (backend/src/db.ts:26-31)`, `mapping_suggestions (57-67)`, `cell_suggestions (132-144)`, `cell_items (151-165)`, `task_logs (219-227)`.
- Обновить `initDB()` чтобы их не создавать.
- Упростить `getCellSummary` (`backend/src/db.ts:760-779`): убрать `LEFT JOIN cell_items`, поле `sum`.
- Чекпоинт: сводка даёт min–max и риск.

### Этап 6. `suggestion_events`: архив, чистка столбцов
- Оставить таблицу, удалить столбцы: `discipline`, `cell_id`, `row_index`, `col_index`.
- Оставить столбцы: `id`, `type`, `suggestion_id`, `action`, `price_id`, `source`, `source_page`, `grp`, `element`, `axis`, `created_at`.
- Удалить запись событий: функцию `insertSuggestionEvent` (`backend/src/db.ts:554-588`) и вызовы (`backend/src/app.ts:139-145,181-185`, `backend/src/tasks.ts:78,88,94`).
- Удалить чтение `/api/events/suggestions` и `getSuggestionEvents` (`backend/src/db.ts:590-602`).
- Миграция SQLite (пересоздание таблицы):
  - `CREATE TABLE suggestion_events_new (id INTEGER PRIMARY KEY AUTOINCREMENT, type TEXT NOT NULL, suggestion_id INTEGER NOT NULL, action TEXT NOT NULL, price_id INTEGER NOT NULL, source TEXT, source_page TEXT, grp TEXT, element TEXT, axis TEXT CHECK(axis IN ('row','col')), created_at DATETIME DEFAULT CURRENT_TIMESTAMP);`
  - `INSERT INTO suggestion_events_new (id,type,suggestion_id,action,price_id,source,source_page,grp,element,axis,created_at) SELECT id,type,suggestion_id,action,price_id,source,source_page,grp,element,axis,created_at FROM suggestion_events;`
  - `ALTER TABLE suggestion_events RENAME TO suggestion_events_old;`
  - `ALTER TABLE suggestion_events_new RENAME TO suggestion_events;`
  - `DROP TABLE suggestion_events_old;`
- Чекпоинт: таблица без лишних столбцов, данные сохранены, новых событий не пишем.

### Этап 7. Сохранить действующую логику расчётов/элементов
- `element_suggestions` и функции: `getElementSuggestions` (`backend/src/db.ts:497-543`), `updateElementSuggestionStatus` (`backend/src/db.ts:545-552`), `getAcceptedElementPrices` (`backend/src/db.ts:965-981`).
- Эндпоинты элементов `backend/src/app.ts:147-186` оставить (служебные/для задач).
- Задачи: оставить `sync_cells`, `compute_collisions_all`, `compute_risk_all` (`backend/src/app.ts:280-291`, `backend/src/tasks.ts:110-183,185-209`).
- Удалить тип/реализацию `build_cell_suggestions_all`: `backend/src/tasks.ts:37-58` и из `allowed` `backend/src/app.ts:284-286`.
- Чекпоинт: расчёты работают, UI без легаси.

### Валидация
- Ручная проверка UI.
- Тесты (тихий режим): `npm run test:ci --silent` для фронта и бэка.
- Smoke‑проверка задач и статусов в «Журнале».

—
Этот план заменяет предыдущий и служит источником правок кода и миграций.
